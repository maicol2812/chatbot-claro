<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asesor Claro</title>

  <!--  Favicon  -->
  <link rel="icon" href="{{ url_for('static', filename='claro-logo.png') }}" type="image/png">

  <!--  Fuentes & librerÃ­as  -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

  <!--  Tu hoja de estilos  -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <!-- â–‘â–‘ Video de fondo â–‘â–‘ -->
  <video id="bg-video" autoplay muted loop>
    <source src="{{ url_for('static', filename='ruta-al-video.mp4') }}" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <!-- â–‘â–‘ Logo fijo â–‘â–‘ -->
  <img class="logo" src="{{ url_for('static', filename='claro-logo.png') }}" alt="Logo Claro">

  <!-- â–‘â–‘ Bienvenida â–‘â–‘ -->
  <section class="welcome animate__animated animate__fadeInUp">
    <h1>Plataformas Core</h1>
    <p>Buen dÃ­a, hablemos de nuestras plataformas de Core.<br>
       Â¿QuÃ© te gustarÃ­a consultar hoy?</p>
  </section>

  <!-- â–‘â–‘ Burbuja de chat â–‘â–‘ -->
  <div id="burbuja-chat" class="burbuja-chat" title="Abrir chat">ğŸ’¬</div>

  <!-- â–‘â–‘ Ventana de chat â–‘â–‘ -->
  <aside id="chat-container" class="chat-container">
      <!-- header -->
      <div class="chat-header d-flex justify-content-between align-items-center">
        <span>Asesor Core</span>
        <span id="expand-toggle" style="cursor:pointer;font-size:1.2rem;">ğŸ—–</span>
      </div>

      <!-- mensajes -->
      <div id="chat-box" class="chat-box"></div>

      <!-- entrada -->
      <form id="chat-form" class="chat-input">
        <input id="chat-input" class="form-control" placeholder="Escribe tu mensajeâ€¦" autocomplete="off">
        <button type="button" class="btn btn-light" title="Ayuda" onclick="showQuickHelp()">â“</button>
        <button type="submit" class="btn btn-danger">Enviar</button>
      </form>
  </aside>

  <!-- â–‘â–‘ Script principal â–‘â–‘ -->
  <script>
    /* â”€â”€â”€ Referencias DOM â”€â”€â”€ */
    const bubble    = document.getElementById("burbuja-chat");
    const chatBox   = document.getElementById("chat-box");
    const chatCont  = document.getElementById("chat-container");
    const chatForm  = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const expandBtn = document.getElementById("expand-toggle");

    /* â”€â”€â”€ Modo nocturno auto (19-7h) â”€â”€â”€ */
    (()=>{
      const h = new Date().getHours();
      if (h >= 19 || h < 7) document.body.classList.add("night-mode");
    })();

    /* â”€â”€â”€ Abrir / Cerrar chat â”€â”€â”€ */
    bubble.onclick = () =>{
      chatCont.classList.toggle("mostrar");
      if(chatCont.classList.contains("mostrar")){
        greetAndMenu();
      }else{
        chatBox.innerHTML="";              // limpia historial visual
        localStorage.removeItem("history");// borra cache local
      }
    };

    /* â”€â”€â”€ Expandir / Restaurar â”€â”€â”€ */
    expandBtn.onclick = ()=>{
      chatCont.classList.toggle("expandido");
      expandBtn.textContent = chatCont.classList.contains("expandido") ? "ğŸ——" : "ğŸ—–";
    };

    /* â”€â”€â”€ Saludo + MenÃº tras 5 s â”€â”€â”€ */
    function greetAndMenu(){
      bot("Buen dÃ­a, hablemos de nuestras plataformas de Core. Â¿QuÃ© te gustarÃ­a consultar?");
      setTimeout(showMainMenu, 5000);
    }

    /* â”€â”€â”€ Plantilla de botones de menÃº â”€â”€â”€ */
    function showMainMenu(){
      const opts=[
        ["1","Alarmas de plataformas"],
        ["2","DocumentaciÃ³n de plataformas"],
        ["3","Incidentes activos"],
        ["4","Estado operativo"],
        ["5","Cambios activos"],
        ["6","Hablar con el administrador"],
        ["arreglar alerta","ğŸ”§ Arreglar alerta"],
        ["configurar alerta","âš™ï¸ Configurar alerta"],
        ["solucion alerta","ğŸ’¡ SoluciÃ³n alerta"]
      ];
      let html='<div class="bot-msg"><b>ğŸ“‹ MenÃº principal:</b><br>';
      opts.forEach(([v,t])=>{
        html+=`<button class="btn btn-outline-danger btn-sm m-1" onclick="sendOption('${v}')">${t}</button>`;
      });
      html+='</div>';
      chatBox.insertAdjacentHTML("beforeend",html);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    /* â”€â”€â”€ Quick help sin consultar backend â”€â”€â”€ */
    function showQuickHelp(){
      bot(`ğŸ†˜ Opciones rÃ¡pidas:<br>
           ğŸ“„ <a href="#" target="_blank">Manual PDF</a><br>
           ğŸ‘¨â€ğŸ’¼ <a href="mailto:jefe.plataformas@claro.com.co">Contactar administrador</a>`);
    }

    /* â”€â”€â”€ Helpers de mensaje â”€â”€â”€ */
    function bot(txt){
      chatBox.insertAdjacentHTML("beforeend",`<div class="bot-msg">${txt}</div>`);
      chatBox.scrollTop=chatBox.scrollHeight;
    }
    function user(txt){
      chatBox.insertAdjacentHTML("beforeend",`<div class="user-msg">${txt}</div>`);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    /* â”€â”€â”€ EnvÃ­o programÃ¡tico de opciÃ³n â”€â”€â”€ */
    window.sendOption = val =>{
      chatInput.value = val;
      chatForm.dispatchEvent(new Event("submit"));
    };

    /* â”€â”€â”€ EnvÃ­o al backend / AutocorrecciÃ³n incluida â”€â”€â”€ */
    chatForm.addEventListener("submit",async e=>{
      e.preventDefault();
      const msg = chatInput.value.trim();
      if(!msg) return;
      user(msg); chatInput.value="";

      try{
        const r = await fetch("/chat",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({message: msg})
        });
        const data = await r.json();
        bot(data.response);
      }catch(err){
        bot("âš ï¸ No se pudo conectar al servidor.");
        console.error(err);
      }
    });
  </script>
</body>
</html>
