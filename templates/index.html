<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asesor Claro</title>
  <link rel="icon" href="/claro-logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<video autoplay muted loop id="bg-video">
  <source src="{{ url_for('static', filename='ruta-al-video.mp4') }}" type="video/mp4">
</video>

<div class="container info-core">
  <img src="{{ url_for('static', filename='trabajo.jpg') }}" alt="Imagen trabajo" class="img-trabajo">
  <h1>Plataformas Core</h1>
</div>

<div id="burbuja-toggle" class="burbuja-chat">💬</div>

<div class="chat-container" id="chat-container">
  <div class="header">
    <div class="d-flex align-items-center gap-2">
      <img src="{{ url_for('static', filename='claro-logo.png') }}" alt="Claro Logo" class="logo"/>
      <h2 class="m-0 fs-6">Asesor de Plataformas Core</h2>
    </div>
    <button id="expandir-chat" class="btn btn-sm btn-light text-danger" title="Expandir chat">⛶</button>
  </div>

  <div class="chat-box" id="chat-box"></div>

  <form id="chat-form">
    <input type="text" id="user-input" class="form-control" placeholder="Escribe tu mensaje..." autocomplete="off"/>
    <div class="acciones-extras">
      <button type="button" title="Hablar" onclick="activarMicrofono()">🎙️</button>
      <button type="button" title="Ayuda rápida" onclick="mostrarAyuda()">❓</button>
      <button type="button" title="Ver manual" onclick="window.open('/static/manual_uso_chatbot.pdf', '_blank')">📄</button>
      <button type="button" title="Contactar administrador" onclick="window.open('mailto:jefe.plataformas@claro.com.co?subject=Asistencia Chatbot', '_blank')">👨‍💼</button>
      <button type="button" title="Revisar alarmas" onclick="window.open('/estado-alarmas', '_blank')">🔍</button>
    </div>
    <button type="submit">Enviar</button>
  </form>
</div>

<footer>
  © 2025 Claro • <a href="#">Políticas de Privacidad</a> • <a href="#">Soporte</a>
</footer>

<script>
const form = document.getElementById("chat-form");
const input = document.getElementById("user-input");
const chatBox = document.getElementById("chat-box");
const burbuja = document.getElementById("burbuja-toggle");
const chat = document.getElementById("chat-container");

burbuja.addEventListener("click", () => {
  chat.classList.toggle("mostrar");
  if (chat.classList.contains("mostrar")) {
    mostrarMensajeBot("Buen día, hablemos de nuestras plataformas de Core. ¿Qué te gustaría consultar hoy?");
    setTimeout(() => mostrarBotonesMenu(), 2000);
  }
});

document.getElementById("expandir-chat").addEventListener("click", () => {
  chat.classList.toggle("expandido");
  const btn = document.getElementById("expandir-chat");
  btn.textContent = chat.classList.contains("expandido") ? "🗕" : "⛶";
});

function mostrarBotonesMenu() {
  const opciones = [
    "1. Alarmas de plataformas",
    "2. Documentación de las plataformas",
    "3. Incidentes activos de las plataformas",
    "4. Estado operativo de las plataformas",
    "5. Cambios activos de las plataformas",
    "6. Hablar con el administrador"
  ];
  let html = '<div class="bot-msg">📋 <b>Menú principal:</b><br>';
  opciones.forEach(op => {
    html += `<button class="btn btn-sm btn-outline-danger m-1" onclick="enviarOpcion('${op[0]}')">${op}</button><br>`;
  });
  html += '</div>';
  chatBox.innerHTML += html;
  chatBox.scrollTop = chatBox.scrollHeight;
}

function enviarOpcion(valor) {
  input.value = valor;
  form.dispatchEvent(new Event('submit'));
}

function guardarMensaje(tipo, texto) {
  const historial = JSON.parse(localStorage.getItem("chatHistorial")) || [];
  historial.push({ tipo, texto });
  localStorage.setItem("chatHistorial", JSON.stringify(historial));
}

function mostrarMensajeBot(respuesta) {
  chatBox.innerHTML += `<div class="bot-msg">${respuesta.replace(/\\n/g, "<br>")}</div>`;
  guardarMensaje("bot-msg", respuesta);
  chatBox.scrollTop = chatBox.scrollHeight;
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const message = input.value.trim();
  if (!message) return;
  chatBox.innerHTML += `<div class="user-msg">${message}</div>`;
  guardarMensaje("user-msg", message);
  input.value = "";
  try {
    const res = await fetch("https://chatbot-claro.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });
    if (!res.ok) throw new Error("Error del servidor");
    const data = await res.json();
    mostrarMensajeBot(data.response);
  } catch (err) {
    console.error("Error:", err);
    mostrarMensajeBot("⚠️ No se pudo conectar con el servidor.");
  }
});

function activarMicrofono() {
  mostrarMensajeBot("🎙 Función de voz aún no disponible.");
}

function mostrarAyuda() {
  mostrarMensajeBot(
    `<b>🆘 Opciones rápidas:</b><br>
    📄 <a href="{{ url_for('static', filename='manual_uso_chatbot.pdf') }}" target="_blank">Ver manual PDF</a><br>
    👨‍💼 <a href="mailto:jefe.plataformas@claro.com.co">Contactar administrador</a><br>
    🔍 <a href="/estado-alarmas" target="_blank">Revisar alarmas</a>`
  );
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
