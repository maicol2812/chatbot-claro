<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asesor Claro</title>

  <!-- Favicon -->
  <link rel="icon" href="/claro-logo.png" type="image/png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- CSS propio -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Vídeo de fondo -->
  <video autoplay muted loop id="bg-video">
    <source src="{{ url_for('static', filename='ruta-al-video.mp4') }}" type="video/mp4">
  </video>

  <!-- Bloque informativo central -->
  <div class="container info-core">
    <img src="{{ url_for('static', filename='trabajo.jpg') }}" alt="Imagen trabajo" class="img-trabajo">
    <h1>Plataformas Core</h1>
  </div>

  <!-- Botón flotante -->
  <button id="burbuja-toggle" class="burbuja-chat" aria-label="Abrir chat">💬</button>

  <!-- Chat -->
  <section class="chat-container" id="chat-container" aria-live="polite">
    <!-- Header -->
    <header class="header">
      <div class="d-flex align-items-center gap-2">
        <img src="{{ url_for('static', filename='claro-logo.png') }}" alt="Logo Claro" class="logo"/>
        <h2 class="m-0 fs-6">Asesor de Plataformas Core</h2>
      </div>
      <button id="expandir-chat" class="btn btn-sm btn-light text-danger" title="Expandir chat" aria-label="Expandir o contraer">⛶</button>
    </header>

    <!-- Mensajes -->
    <div class="chat-box" id="chat-box"></div>

    <!-- Formulario -->
    <form id="chat-form" aria-label="Enviar mensaje">
      <input type="text"
             id="user-input"
             class="form-control"
             placeholder="Escribe tu mensaje…"
             autocomplete="off"
             aria-label="Caja de texto">

      <div class="acciones-extras">
        <button type="button" title="Audio (no disponible)" onclick="activarMicrofono()">🎙️</button>
        <button type="button" title="Ayuda" onclick="mostrarAyuda()">❓</button>
      </div>

      <button type="submit" aria-label="Enviar">Enviar</button>
    </form>
  </section>

  <!-- Footer -->
  <footer>
    © 2025 Claro • <a href="#">Políticas de Privacidad</a> • <a href="#">Soporte</a>
  </footer>

  <!-- JS -->
  <script>
    const form      = document.getElementById("chat-form");
    const input     = document.getElementById("user-input");
    const chatBox   = document.getElementById("chat-box");
    const burbuja   = document.getElementById("burbuja-toggle");
    const chat      = document.getElementById("chat-container");

    /* Abrir / cerrar */
    burbuja.addEventListener("click", () => {
      chat.classList.toggle("mostrar");
      if (chat.classList.contains("mostrar")) {
        mostrarMensajeBot("Buen día, hablemos de nuestras plataformas de Core. ¿Qué te gustaría consultar hoy?");
        setTimeout(mostrarBotonesMenu, 1800);
      }
    });

    /* Expandir */
    document.getElementById("expandir-chat").addEventListener("click", () => {
      chat.classList.toggle("expandido");
      const btn = document.getElementById("expandir-chat");
      btn.textContent = chat.classList.contains("expandido") ? "🗕" : "⛶";
    });

    /* Menú */
    function mostrarBotonesMenu () {
      const opciones = [
        "1. Alarmas de plataformas",
        "2. Documentación de las plataformas",
        "3. Incidentes activos de las plataformas",
        "4. Estado operativo de las plataformas",
        "5. Cambios activos de las plataformas",
        "6. Hablar con el administrador"
      ];
      let html = '<div class="bot-msg">📋 <b>Menú principal:</b><br>';
      opciones.forEach(op => {
        html += `<button class="btn btn-sm btn-outline-danger m-1" onclick="enviarOpcion('${op[0]}')">${op}</button><br>`;
      });
      html += '</div>';
      chatBox.insertAdjacentHTML("beforeend", html);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function enviarOpcion (valor) {
      input.value = valor;
      form.dispatchEvent(new Event('submit'));
    }

    /* Mensajes */
    function mostrarMensajeBot (texto) {
      chatBox.insertAdjacentHTML("beforeend",
        `<div class="bot-msg">${texto.replace(/\\n/g, "<br>")}</div>`);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function activarMicrofono () {
      mostrarMensajeBot("🎙 Función de voz no disponible aún.");
    }

    function mostrarAyuda () {
      mostrarMensajeBot(
        `<b>🆘 Opciones rápidas:</b><br>
         📄 <a href="https://tu-pdf-hosting.com/manual.pdf" target="_blank">Ver manual PDF</a><br>
         👨‍💼 <a href="mailto:jefe.plataformas@claro.com.co">Contactar administrador</a><br>
         🔍 <a href="https://jefatura-url-de-alarmas.sharepoint.com">Revisar alarmas</a>`
      );
    }

    /* Envía mensaje */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      /* tu mensaje */
      chatBox.insertAdjacentHTML("beforeend",
        `<div class="user-msg">${message}</div>`);

      /* placeholder “escribiendo…” */
      const loader = document.createElement("div");
      loader.className = "bot-msg typing-dots";
      loader.innerHTML = "<span></span><span></span><span></span>";
      chatBox.appendChild(loader);
      chatBox.scrollTop = chatBox.scrollHeight;
      input.value = "";

      try {
        const res = await fetch("https://chatbot-claro.onrender.com/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        if (!res.ok) throw new Error();
        const data = await res.json();
        loader.remove();
        mostrarMensajeBot(data.response);
      } catch (err) {
        console.error("❌ Error:", err);
        loader.remove();
        mostrarMensajeBot("⚠️ No se pudo conectar con el servidor. Intenta de nuevo más tarde.");
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>
