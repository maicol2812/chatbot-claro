<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Claro - Chat</title>
    
    <!-- Recursos estáticos -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="chat-wrapper">
        <!-- Header con logo -->
        <div class="chat-header">
            <img src="{{ url_for('static', filename='logo-claro.png') }}" alt="Claro" class="logo">
            <h1>Chat de Alarmas</h1>
        </div>

        <!-- Contenedor principal del chat -->
        <div id="chatContainer" class="chat-container">
            <div id="chatMessages" class="chat-messages"></div>
            
            <!-- Indicador de escritura -->
            <div id="typingIndicator" class="typing-indicator hidden">
                <span></span><span></span><span></span>
            </div>
            
            <!-- Input y botón -->
            <div class="chat-input-area">
                <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." autocomplete="off">
                <button id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Script con defer -->
    <script src="{{ url_for('static', filename='main.js') }}" defer></script>
</body>
</html>
        
        .user {
            background: #f5f5f5;
            margin-left: 20%;
            text-align: right;
        }
        
        .options button {
            margin: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: #e60012;
            color: white;
            cursor: pointer;
        }
        
        .options button:hover {
            background: #cc0010;
        }
        
        .alarma-details {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .pdf-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background: #4caf50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        
        .pdf-link:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <script>
        const Chat = {
            state: {
                step: 'inicio',
                numero: null
            },
            
            init() {
                this.mostrarSaludo();
            },
            
            async mostrarSaludo() {
                this.addBotMessage(`Buen día, hablemos de nuestras plataformas de Core. ¿Qué te gustaría consultar el día de hoy?`, [
                    "1. Alarmas de plataformas",
                    "2. Documentación de las plataformas",
                    "3. Incidentes activos de las plataformas",
                    "4. Estado operativo de las plataformas",
                    "5. Cambios activos en las plataformas",
                    "6. Hablar con el administrador de la plataforma"
                ]);
            },
            
            addBotMessage(text, options = []) {
                const div = document.createElement('div');
                div.className = 'message bot';
                div.innerHTML = text;
                
                if (options.length > 0) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'options';
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.textContent = opt;
                        btn.onclick = () => this.handleOption(opt);
                        optionsDiv.appendChild(btn);
                    });
                    div.appendChild(optionsDiv);
                }
                
                document.getElementById('chatMessages').appendChild(div);
                this.scrollToBottom();
            },
            
            addUserMessage(text) {
                const div = document.createElement('div');
                div.className = 'message user';
                div.textContent = text;
                document.getElementById('chatMessages').appendChild(div);
                this.scrollToBottom();
            },
            
            async handleOption(option) {
                this.addUserMessage(option);
                
                if (option.startsWith('1.')) {
                    this.state.step = 'numero_alarma';
                    this.addBotMessage('Por favor ingrese el número de alarma que desea consultar:');
                    return;
                }
                
                this.addBotMessage('Esta opción estará disponible próximamente.');
            },
            
            async processInput(text) {
                if (this.state.step === 'numero_alarma') {
                    this.state.numero = text;
                    this.state.step = 'elemento';
                    this.addBotMessage('Por favor ingresa el nombre del elemento que reporta la alarma:');
                    return;
                }
                
                if (this.state.step === 'elemento') {
                    await this.buscarAlarma(this.state.numero, text);
                    this.state.step = 'inicio';
                    return;
                }
                
                this.addBotMessage('No entiendo tu mensaje. ¿Puedes seleccionar una opción del menú?');
            },
            
            async buscarAlarma(numero, elemento) {
                try {
                    const response = await fetch('/api/buscar_alarma', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ numero, elemento })
                    });
                    
                    const data = await response.json();
                    
                    if (data.encontrada) {
                        let message = `<div class="alarma-details">
                            <h3>Detalles de la Alarma</h3>
                            <p><strong>Fabricante:</strong> ${data.datos['Fabricante']}</p>
                            <p><strong>Servicio:</strong> ${data.datos['SERVICIO Y/O SISTEMA GESTIONADO']}</p>
                            <p><strong>Severidad:</strong> ${data.datos['SEVERIDAD']}</p>
                            <p><strong>Descripción:</strong> ${data.datos['TEXTO 1 DE LA ALARMA']}</p>
                            <p><strong>Grupo de Atención:</strong> ${data.datos['GRUPO DE ATENCIÓN']}</p>`;
                            
                        if (data.tiene_pdf) {
                            message += `<a href="${data.pdf_url}" target="_blank" class="pdf-link">Ver Instructivo PDF</a>`;
                        }
                        
                        message += '</div>';
                        
                        this.addBotMessage(message);
                    } else {
                        this.addBotMessage(data.mensaje);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.addBotMessage('Ocurrió un error al buscar la alarma. Por favor intenta nuevamente.');
                }
                
                // Mostrar menú principal nuevamente
                setTimeout(() => this.mostrarSaludo(), 2000);
            },
            
            scrollToBottom() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        };

        // Inicializar chat
        document.addEventListener('DOMContentLoaded', () => {
            Chat.init();
            
            // Manejar entrada por teclado
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const text = prompt('Ingresa tu mensaje:');
                    if (text) {
                        Chat.addUserMessage(text);
                        Chat.processInput(text);
                    }
                }
            });
        });
    </script>
</body>
</html>
